# 自动部署和验证指南

## 已完成的工作

### 1. 代码修复 ✅
- **提交ID**: c8b4d2f
- **修改**: `db_models.py` - 修改重复检查逻辑
- **状态**: 已推送到GitHub

### 2. 自动迁移配置 ✅
- **提交ID**: ee8c552
- **新增文件**: 
  - `migrate_database.py` - 自动迁移脚本
  - 修改 `render.yaml` - 配置自动执行迁移
- **状态**: 已推送到GitHub

## Render自动部署流程

### 部署步骤
Render会自动执行以下步骤:

1. **检测GitHub更新** ✅
   - Render已检测到新提交
   
2. **开始构建**
   - 执行: `pip install -r requirements.txt`
   - 执行: `python migrate_database.py`
   - 迁移脚本会自动:
     - 删除旧约束 `UNIQUE(user_id, punch_time)`
     - 添加新约束 `UNIQUE(user_id, punch_date, punch_time)`

3. **启动应用**
   - 初始化数据库
   - 启动Web服务器

### 预计时间
- 总部署时间: 2-5分钟
- 数据库迁移: 5-10秒

## 如何验证部署

### 方法1: 查看Render控制台

1. 访问 https://dashboard.render.com
2. 找到 `punch-time` 服务
3. 查看 "Events" 标签
4. 确认最新部署状态为 "Live"

### 方法2: 查看部署日志

1. 在Render控制台点击 "Logs"
2. 查找以下关键信息:

```
开始数据库迁移...
检查当前约束...
找到约束: ['punches_user_id_punch_time_key']
删除旧约束: punches_user_id_punch_time_key
✓ 已删除约束: punches_user_id_punch_time_key
添加新的唯一约束...
✓ 已添加新约束: punches_user_id_punch_date_punch_time_key
✓ 数据库迁移成功!
```

## 功能验证清单

### 测试1: 手动末班打卡 ⭐ 重点测试

1. 访问 https://punch-time.onrender.com
2. 登录您的账号
3. 选择日期: 2026-01-05
4. 添加打卡: 18:00
5. **勾选"末班打卡"选项** ✓
6. 点击打卡

**预期结果**:
- ✅ 2026-01-04 应该看到这条 18:00 的打卡(作为最后一条)
- ✅ 2026-01-05 也应该看到这条 18:00 的打卡

### 测试2: 自动末班打卡(凌晨5点前)

1. 选择日期: 2026-01-06
2. 添加打卡: 03:30
3. 不需要勾选"末班打卡"(自动判断)

**预期结果**:
- ✅ 2026-01-05 应该看到 03:30 的打卡
- ✅ 2026-01-06 也应该看到 03:30 的打卡
- ✅ 显示"已记录第 X 次打卡(末班)"

### 测试3: 边界测试

**测试 04:59**:
- 选择日期: 2026-01-07
- 添加打卡: 04:59
- 预期: 应该复制到 2026-01-06 ✅

**测试 05:00**:
- 选择日期: 2026-01-07
- 添加打卡: 05:00
- 预期: 不应该复制到 2026-01-06 ✅

### 测试4: 删除功能

1. 删除一条末班打卡记录
2. 验证:
   - ✅ 当天的记录被删除
   - ✅ 前一天的记录也被删除

### 测试5: 导出功能

1. 点击"导出数据"
2. 打开CSV文件
3. 验证:
   - ✅ 末班打卡只在前一天显示一次
   - ✅ 不会出现重复记录

## 故障排查

### 如果部署失败

1. **查看部署日志**
   - 在Render控制台查看详细错误信息
   
2. **常见错误**:
   - 数据库连接失败: 检查DATABASE_URL环境变量
   - 迁移脚本失败: 查看具体错误信息
   - 依赖安装失败: 检查requirements.txt

3. **回滚方案**:
   ```bash
   # 本地回滚到上一个版本
   git revert ee8c552
   git push origin main
   ```

### 如果迁移失败

迁移脚本使用了 `|| true`,即使迁移失败,部署也会继续。

**检查方法**:
1. 查看部署日志中的迁移输出
2. 如果看到错误,可能需要手动执行迁移
3. 参考 `Render数据库迁移指南.md` 手动执行

### 如果功能仍然不工作

1. **清除浏览器缓存**
   - Ctrl + Shift + Delete
   - 强制刷新: Ctrl + F5

2. **检查代码版本**
   - 访问: https://raw.githubusercontent.com/sayanget/punch-time/main/db_models.py
   - 确认包含修改后的代码

3. **检查数据库约束**
   - 使用Render Shell连接数据库
   - 执行: `SELECT conname FROM pg_constraint WHERE conrelid = 'punches'::regclass AND contype = 'u';`
   - 确认有 `punches_user_id_punch_date_punch_time_key`

## 完成后的状态

### 数据库
- ✅ 旧约束已删除: `UNIQUE(user_id, punch_time)`
- ✅ 新约束已添加: `UNIQUE(user_id, punch_date, punch_time)`

### 代码
- ✅ `db_models.py`: 修改了重复检查逻辑
- ✅ `app.py`: 使用5点阈值
- ✅ `migrate_database.py`: 自动迁移脚本
- ✅ `render.yaml`: 配置自动执行迁移

### 功能
- ✅ 手动末班打卡可以复制到前一天
- ✅ 凌晨5点前自动判断为末班打卡
- ✅ 删除时同步删除两天的记录
- ✅ 导出时自动去重

## 相关文档

- [问题修复说明](file:///d:/project/punch_timer/问题修复说明_唯一约束.md)
- [数据库迁移SQL](file:///d:/project/punch_timer/database_migration_unique_constraint.sql)
- [迁移脚本](file:///d:/project/punch_timer/migrate_database.py)
- [Render配置](file:///d:/project/punch_timer/render.yaml)

## 下一步

1. ⏳ 等待Render部署完成(2-5分钟)
2. ✅ 查看部署日志确认迁移成功
3. ✅ 测试手动末班打卡功能
4. ✅ 测试自动末班打卡功能
5. ✅ 确认所有功能正常工作
