# 打卡计时器 - 完整功能说明

## 项目概述

打卡计时器是一个功能完整的多用户打卡系统，支持Web界面操作和多种运行模式。

## 主要功能

### 1. 多用户系统
- 用户注册和登录功能
- 每个用户独立的打卡记录
- 数据隔离，只能查看和管理自己的记录

### 2. 打卡功能
- 每日4次打卡（支持多次打卡）
- 手动时间输入功能
- 末班打卡功能（支持跨天计算）

### 3. 时间计算
- 自动计算各时段间隔时间
- 第二次到第三次打卡计时器
- 当前班次时长计算（剔除休息间隔）

### 4. 数据管理
- 打卡记录删除功能
- 数据导出为CSV格式
- 按日期查看历史记录

### 5. 多语言支持
- 中文、英文、西班牙文切换
- 完整的国际化支持

### 6. 移动端适配
- 响应式设计
- 适配各种屏幕尺寸

### 7. 系统托盘模式（传统方法）
- 跟随系统启动
- 最小化到右下角系统托盘
- 显示服务运行状态
- 便捷的托盘菜单操作
- **防无限弹窗机制**（最新改进）

### 8. Windows服务模式（NSSM方法 - 推荐）
- 作为Windows服务运行
- 系统启动时自动运行（无需用户登录）
- 更高的稳定性和可靠性
- 自动重启机制
- 专业级服务管理

### 9. 系统托盘服务管理器（新增）
- 系统托盘图标常驻右下角
- 右键菜单提供服务控制选项
- 可启动/停止/重启NSSM服务
- 检查服务状态
- 直接打开Web应用

## 运行模式

### 模式1：传统Web模式
```cmd
python app.py
```
访问 http://localhost:7777

### 模式2：系统托盘模式
```cmd
python system_tray_app.py
```
或运行 `punch_timer_system_tray.exe`

### 模式3：Windows服务模式（NSSM方法 - 推荐）

#### 安装服务
1. 下载并安装NSSM: https://nssm.cc/download
2. 将nssm.exe复制到系统PATH目录（如C:\Windows\System32）
3. 以管理员权限运行 `install_nssm_service.bat`

#### 服务管理
- 启动服务: `net start PunchTimerService`
- 停止服务: `net stop PunchTimerService`
- 查看状态: `sc query PunchTimerService`
- 使用管理工具: 运行 `manage_service.bat`

#### 卸载服务
以管理员权限运行 `uninstall_nssm_service.bat`

### 模式4：系统托盘服务管理器（新增）
运行 `start_tray_manager.bat` 启动托盘管理器，提供图形化界面管理NSSM服务

### 模式5：一键启动
运行 `start_app.bat` 或 `start_app.ps1`

## 系统托盘功能说明

### 安装方法

1. **自动安装**（推荐）：
   - 以管理员权限运行 `setup_system_tray.bat`
   - 脚本将自动安装依赖并添加到系统启动项

2. **手动安装**：
   - 安装依赖：`pip install -r requirements.txt`
   - 以管理员权限运行：`python start_system_tray.py add`

### 使用方法

右键单击系统托盘图标可访问以下菜单：

- **打开应用** - 在浏览器中打开打卡界面
- **服务状态** - 检查Web服务运行状态（通过控制台输出，而非弹窗）
- **重启服务** - 重启Web服务（通过控制台输出，而非弹窗）
- **退出** - 停止服务并退出托盘应用

### 防无限弹窗机制（最新改进）

为解决可能出现的无限弹窗问题，我们实施了以下改进：

1. **消息通知优化**：
   - 服务状态检查不再使用阻塞式弹窗
   - 改为控制台输出和非阻塞通知
   - 避免初始化阶段的自动弹窗

2. **错误处理增强**：
   - 所有UI操作都包含异常处理
   - 防止因错误导致的重复弹窗循环

3. **服务管理改进**：
   - 重启服务操作改为后台处理
   - 状态反馈通过控制台而非弹窗

## 系统托盘服务管理器功能（新增）

### 功能特点

系统托盘服务管理器提供图形化界面来管理NSSM服务：

- **常驻系统托盘** - 图标常驻右下角系统托盘区域
- **右键菜单控制** - 提供完整的服务控制选项
- **状态监控** - 实时检查服务运行状态
- **便捷访问** - 一键打开Web应用界面

### 菜单选项

右键点击托盘图标可访问：

- **打开Web应用** - 直接在浏览器中打开打卡界面
- **启动服务** - 启动NSSM注册的打卡计时器服务
- **停止服务** - 停止运行中的服务
- **重启服务** - 重新启动服务
- **检查状态** - 查看服务当前运行状态
- **退出** - 退出托盘管理器

### 启动方法

运行 `start_tray_manager.bat` 或直接运行 `python tray_service_manager.py`

## NSSM服务模式优势

### 为什么选择NSSM服务模式

1. **系统级启动** - 服务在系统启动时自动运行，无需用户登录
2. **高稳定性** - 服务崩溃时自动重启，确保持续运行
3. **后台运行** - 无用户界面，不占用桌面资源
4. **权限管理** - 可以配置为系统账户运行，权限更高
5. **专业管理** - 标准Windows服务管理方式

### NSSM服务配置

- 服务名称: PunchTimerService
- 启动类型: 自动启动
- 重启策略: 失败时自动重启
- 工作目录: 项目根目录
- 环境变量: PYTHONPATH设置为项目目录

## 文件说明

- `punch_timer_system_tray.exe` - 独立的系统托盘应用（单文件exe）
- `punch_timer_service.py` - 服务版本应用
- `tray_service_manager.py` - 系统托盘服务管理器
- `system_tray_app.py` - 系统托盘应用源码
- `start_system_tray.py` - 启动项管理脚本
- `install_nssm_service.bat` - NSSM服务安装脚本
- `uninstall_nssm_service.bat` - NSSM服务卸载脚本
- `manage_service.bat` - 服务管理工具
- `start_tray_manager.bat` - 启动托盘管理器脚本
- `setup_system_tray.bat` - 自动安装脚本
- `add_to_startup.ps1` - PowerShell启动项脚本
- `NSSM_INSTALL_GUIDE.md` - NSSM安装配置指南

## 独立exe文件

项目包含两个独立的exe文件：

1. `punch_timer.exe` - 传统的Web应用模式
2. `punch_timer_system_tray.exe` - 系统托盘模式

## 系统托盘exe特点

- **单文件分发**：无需安装，双击即可运行
- **系统启动**：可设置跟随Windows启动
- **后台运行**：最小化到系统托盘，不占用任务栏
- **状态监控**：随时查看服务运行状态
- **便捷操作**：托盘菜单提供快速访问功能
- **防无限弹窗**：优化的消息通知机制

## NSSM服务exe特点

- **系统服务**：作为Windows服务运行
- **自动启动**：系统启动时自动运行
- **高可用性**：崩溃自动重启
- **无界面**：后台静默运行
- **专业管理**：标准服务管理命令

## 卸载方法

### 系统托盘模式
1. 运行 `python start_system_tray.py remove` 移除启动项
2. 或手动删除注册表项：`HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run\PunchTimer`

### NSSM服务模式
1. 运行 `uninstall_nssm_service.bat` (以管理员权限)
2. 或手动运行: `nssm remove PunchTimerService confirm`

## 注意事项

1. 系统托盘模式需要管理员权限来添加到启动项
2. NSSM服务模式需要先安装NSSM工具
3. 首次运行可能需要允许防火墙访问
4. 应用默认运行在7777端口
5. 数据文件保存在应用同目录下
6. 服务状态检查和重启操作现在通过控制台输出反馈，而非弹窗
7. NSSM服务模式提供最高的稳定性和可靠性
8. 系统托盘服务管理器提供图形化界面管理NSSM服务