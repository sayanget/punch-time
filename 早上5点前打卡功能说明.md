# 早上5点前打卡记录自动复制功能

## 功能概述

当员工加班到第二天凌晨时,系统会自动将**早上5点前**的打卡记录复制到前一天,作为前一天的最后一条打卡记录。

这个功能专门用于处理**加班到第二天上午**的场景。

## 使用场景

### 典型场景
员工在 2026-01-02 工作,一直加班到 2026-01-03 凌晨 3:30 才下班。

**系统行为:**
- 在 2026-01-03 凌晨 3:30 打卡时
- 系统自动将这条记录同时保存到:
  - **2026-01-02** (前一天) - 作为最后一条打卡记录
  - **2026-01-03** (当天) - 正常记录

### 为什么需要这个功能?

1. **准确记录工作时长**: 凌晨的打卡实际上是前一天工作的延续
2. **方便统计**: 可以在前一天看到完整的工作记录
3. **符合实际**: 反映真实的工作情况

## 技术实现

### 修改的文件
- `app.py` - 主应用文件(3处修改)

### 关键代码位置

#### 1. 打卡时自动判断 (第123-126行)
```python
# 自动判断是否为末班打卡(时间在早上5点前)
hour = int(time_parts[0])
is_late_shift_auto = hour < 5  # 早上5点前的打卡自动标记为末班打卡
is_late_shift = is_late_shift_manual or is_late_shift_auto
```

#### 2. 创建双记录 (第135-142行)
```python
# 如果是末班打卡,同时添加到前一天的记录中
if is_late_shift:
    current_date = datetime.strptime(date, '%Y-%m-%d')
    previous_date = current_date - timedelta(days=1)
    previous_date_str = previous_date.strftime('%Y-%m-%d')
    
    # 添加到前一天的记录中
    add_punch(user_id, previous_date_str, punch_time, is_late_shift)
```

#### 3. 删除时同步删除 (第170-181行)
```python
# 检查是否为末班打卡(凌晨5点前的记录)
# 如果是,也需要从前一天的记录中删除
if punch_dt.hour < 5:
    # 计算前一天的日期
    previous_date = current_date - timedelta(days=1)
    # 从前一天的记录中也删除
    delete_punch(user_id, timestamp)
```

#### 4. 导出时自动去重 (第219-226行)
```python
# 检查是否为末班打卡(凌晨5点前)
if dt.hour < 5:
    # 如果这个时间戳已经在前一天处理过,跳过
    if t in processed_late_shifts:
        continue
    processed_late_shifts.add(t)
```

## 使用方法

### 1. 正常打卡流程

1. 打开打卡系统: http://localhost:7777
2. 登录您的账号
3. 选择日期和时间
4. 点击"打卡"按钮

### 2. 加班打卡示例

**场景**: 2026-01-02 加班到 2026-01-03 凌晨 3:30

**操作步骤**:

1. **添加 2026-01-02 的正常打卡**:
   - 08:30 - 上班
   - 12:00 - 午休
   - 13:30 - 下午上班
   - 18:00 - 正常下班

2. **添加加班打卡**:
   - 日期选择: 2026-01-03
   - 时间输入: 03:30
   - 点击"打卡"

3. **查看结果**:
   - 查看 2026-01-02: 会看到 5 条记录(包括凌晨 3:30)
   - 查看 2026-01-03: 会看到 1 条记录(凌晨 3:30)

### 3. 时间阈值说明

| 打卡时间 | 是否复制到前一天 | 说明 |
|---------|----------------|------|
| 00:00 - 04:59 | ✓ 是 | 自动复制到前一天 |
| 05:00 - 23:59 | ✗ 否 | 只记录在当天 |

**边界测试**:
- 04:59 → 会复制到前一天
- 05:00 → 不会复制到前一天

## 数据库说明

### 表结构
```sql
CREATE TABLE punches (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    punch_date DATE NOT NULL,           -- 打卡日期
    punch_time TIMESTAMP NOT NULL,      -- 打卡时间
    is_late_shift BOOLEAN DEFAULT 0,    -- 是否为末班打卡
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 数据示例

**添加凌晨 3:30 打卡后的数据库记录**:

| id | user_id | punch_date | punch_time | is_late_shift |
|----|---------|------------|------------|---------------|
| 1  | 1       | 2026-01-02 | 2026-01-02T08:30 | 0 |
| 2  | 1       | 2026-01-02 | 2026-01-02T12:00 | 0 |
| 3  | 1       | 2026-01-02 | 2026-01-02T13:30 | 0 |
| 4  | 1       | 2026-01-02 | 2026-01-02T18:00 | 0 |
| 5  | 1       | 2026-01-02 | 2026-01-03T03:30 | 1 |
| 6  | 1       | 2026-01-03 | 2026-01-03T03:30 | 1 |

**注意**: 
- 记录 5 和 6 的 `punch_time` 相同,但 `punch_date` 不同
- `is_late_shift = 1` 表示这是末班打卡

## 导出功能

### CSV导出说明

点击"导出数据"按钮后,系统会:

1. **自动去重**: 凌晨的打卡记录只在前一天显示一次
2. **格式化时间**: 使用易读的格式 (YYYY-MM-DD HH:MM:SS)
3. **计算时长**: 自动计算上午、下午和总工作时长

### 导出示例

```csv
日期,第1次,第2次,第3次,第4次,上午时长,下午时长,总时长
2026-01-02,2026-01-02 08:30:00,2026-01-02 12:00:00,2026-01-02 13:30:00,2026-01-03 03:30:00,3小时30分钟,14小时0分钟,17小时30分钟
```

**说明**: 第4次打卡显示的是凌晨 3:30,但只在 2026-01-02 这一行出现

## 删除功能

### 删除行为

当您删除一条凌晨 5 点前的打卡记录时:

1. 系统会自动从**两个日期**都删除该记录
2. 确保数据一致性
3. 不会留下孤立的记录

### 删除示例

**操作**: 删除 2026-01-03 凌晨 3:30 的打卡

**结果**:
- 从 2026-01-02 的记录中删除
- 从 2026-01-03 的记录中删除

## 测试方法

### 方法1: 手动测试(推荐)

1. 启动应用:
   ```bash
   cd d:\project\punch_timer
   python app.py
   ```

2. 打开浏览器: http://localhost:7777

3. 按照上面的"使用方法"进行测试

### 方法2: 数据库查询验证

使用 SQLite 工具查询数据库:

```sql
-- 查看所有打卡记录
SELECT 
    punch_date as 日期,
    punch_time as 时间,
    is_late_shift as 是否末班
FROM punches
WHERE user_id = 1
ORDER BY punch_time;

-- 查看特定日期的记录
SELECT 
    punch_date,
    punch_time,
    CASE WHEN is_late_shift = 1 THEN '是' ELSE '否' END as 末班打卡
FROM punches
WHERE user_id = 1 
    AND punch_date IN ('2026-01-02', '2026-01-03')
ORDER BY punch_time;
```

## 常见问题

### Q1: 为什么选择5点作为阈值?
**A**: 5点是一个合理的分界点,大多数夜班工作会在凌晨5点前结束。这个时间可以根据实际需求调整。

### Q2: 如果我在凌晨4点打卡,会怎样?
**A**: 系统会自动将这条记录同时保存到前一天和当天,您在两天的记录中都能看到。

### Q3: 导出的CSV会有重复记录吗?
**A**: 不会。导出功能已经实现了智能去重,凌晨的打卡只会在前一天显示一次。

### Q4: 可以手动标记末班打卡吗?
**A**: 可以。在添加打卡时,可以手动勾选"末班打卡"选项,即使时间不在凌晨5点前。

### Q5: 删除记录会影响两天的数据吗?
**A**: 是的。删除凌晨5点前的打卡记录时,系统会自动从两个日期都删除,保持数据一致性。

### Q6: 这个功能会影响工作时长计算吗?
**A**: 会。凌晨的打卡会被计入前一天的工作时长,更准确地反映实际工作时间。

## 注意事项

1. **时区**: 系统使用本地时间,不涉及时区转换
2. **唯一性**: 数据库使用 `(user_id, punch_time)` 作为唯一约束,防止重复打卡
3. **标记**: 凌晨5点前的打卡会自动标记为 `is_late_shift = True`
4. **删除**: 删除凌晨打卡时,两个日期的记录都会被删除

## 修改历史

| 日期 | 修改内容 | 修改人 |
|------|---------|--------|
| 2026-01-02 | 将阈值从6点改为5点 | - |
| 原始版本 | 使用6点作为阈值 | - |

## 技术支持

如有问题,请检查:
1. 数据库连接是否正常
2. 打卡时间格式是否正确
3. 用户是否已登录
4. 浏览器控制台是否有错误信息
