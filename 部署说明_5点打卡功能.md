# 部署说明 - 早上5点前打卡功能

## 部署信息

### Git提交信息
- **提交ID**: 6004946
- **提交信息**: feat: 将早上打卡阈值从6点改为5点,支持加班到第二天上午的场景
- **分支**: main
- **远程仓库**: https://github.com/sayanget/punch-time

### 修改的文件
1. `app.py` - 主应用文件(3处修改)
2. `早上5点前打卡功能说明.md` - 中文功能说明文档
3. `EARLY_MORNING_PUNCH_TEST_GUIDE.md` - 英文测试指南

### 部署时间
- **推送时间**: 2026-01-02 18:50 (本地时间)

## Render自动部署

### 部署流程
1. ✅ 代码已推送到GitHub
2. 🔄 Render自动检测到更新
3. 🔄 Render开始构建和部署
4. ⏳ 等待部署完成(通常需要2-5分钟)

### 查看部署状态
1. 访问Render控制台: https://dashboard.render.com
2. 找到 `punch-time` 服务
3. 查看"Events"标签页,确认部署状态

### 部署完成后的验证

#### 1. 访问线上应用
- URL: https://punch-time.onrender.com
- 登录您的账号

#### 2. 测试新功能
**测试步骤**:
1. 选择日期: 2026-01-02
2. 添加正常打卡: 08:30, 12:00, 13:30, 18:00
3. 选择日期: 2026-01-03
4. 添加凌晨打卡: 03:30
5. 返回查看 2026-01-02,应该看到5条记录(包括凌晨3:30)
6. 查看 2026-01-03,应该看到1条记录(凌晨3:30)

#### 3. 验证边界情况
- 测试 04:59 (应该复制到前一天)
- 测试 05:00 (不应该复制到前一天)

#### 4. 测试删除功能
- 删除凌晨的打卡记录
- 验证两天的记录都被删除

#### 5. 测试导出功能
- 点击"导出数据"
- 检查CSV文件中凌晨记录只在前一天出现一次

## 预期行为

### 功能说明
当用户在**早上5点前**打卡时:
- 记录会同时保存到当天和前一天
- 前一天显示为最后一条打卡记录
- 导出时自动去重,只在前一天显示
- 删除时同步删除两天的记录

### 数据库变化
```sql
-- 凌晨3:30打卡后的数据库记录示例
-- 会有两条记录,punch_time相同但punch_date不同
INSERT INTO punches (user_id, punch_date, punch_time, is_late_shift)
VALUES 
  (1, '2026-01-02', '2026-01-03T03:30', 1),  -- 前一天的记录
  (1, '2026-01-03', '2026-01-03T03:30', 1);  -- 当天的记录
```

## 回滚方案

如果部署后发现问题,可以快速回滚:

### 方法1: Git回滚
```bash
# 回滚到上一个版本
git revert 6004946

# 推送回滚
git push origin main
```

### 方法2: Render手动回滚
1. 访问Render控制台
2. 进入服务详情页
3. 点击"Manual Deploy"
4. 选择之前的部署版本

## 监控建议

### 部署后监控
1. **检查应用日志**: 在Render控制台查看是否有错误
2. **测试关键功能**: 确保正常打卡和凌晨打卡都能正常工作
3. **数据库检查**: 验证数据库中的记录是否正确

### 常见问题

**Q: 部署需要多长时间?**
A: 通常2-5分钟,Render会自动构建和部署

**Q: 如何确认部署成功?**
A: 在Render控制台的Events中看到"Deploy succeeded"消息

**Q: 部署失败怎么办?**
A: 检查Render日志,如果是代码问题可以快速回滚

**Q: 会影响现有数据吗?**
A: 不会,这次修改只改变了逻辑,不涉及数据库结构变更

## 后续步骤

1. ⏳ 等待Render部署完成(2-5分钟)
2. ✅ 访问线上应用测试新功能
3. ✅ 验证凌晨打卡是否正确复制到前一天
4. ✅ 测试删除和导出功能
5. ✅ 确认一切正常后通知用户

## 技术细节

### 修改摘要
- 将早上打卡阈值从 `hour < 6` 改为 `hour < 5`
- 影响3个位置:
  1. 打卡创建逻辑 (app.py:125)
  2. 删除同步逻辑 (app.py:174)
  3. 导出去重逻辑 (app.py:222)

### 兼容性
- ✅ 向后兼容,不影响现有数据
- ✅ 不需要数据库迁移
- ✅ 不需要修改环境变量

### 性能影响
- 无明显性能影响
- 凌晨打卡会多一次数据库写入(复制到前一天)
- 删除操作可能需要删除两条记录
